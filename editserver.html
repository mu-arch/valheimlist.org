<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Servers! - Valheimlist.org</title>

    <link rel="preconnect" href="https://api.valheimlist.org">
    <link rel="stylesheet" href="assets/css/listing.css">
    <link rel="stylesheet" href="assets/css/icons.css">
</head>
<body>
<div class="width-container">
    <nav>
    <img onclick="window.location.href = 'https://valheimlist.org'" class="logo-mast" src="../assets/img/logo.svg" alt="Valheimlist.org">
    <div onclick="window.location.href = 'https://valheimlist.org';" id="see-all-servers"><span class="ico-server"></span>Browse servers</div>
    <div id="disbtn" class="discord-button" onClick="discord_button_action()">
        <span class="ico-discord"></span>
        Login
    </div>

    </nav>
    <div class="edit-server preload">
        <h1 id="name-2">Edit ""</h1>

        <div class="item-block" id="page-url"></div>

        <div class="item-block">
            <h3>Set public:</h3>
            <p>Enable this when you are ready for your server to appear in the public server list. People with the direct URL of your page can always view it even when not public.</p>
            <p>Failing to respond to a Steamworks Challenge for more than 7 days will automatically make your server private.</p>
            <label class="form-switch">
                <input id="is_public" type="checkbox">
                <i></i>
            </label>
        </div>

        <div class="item-block">
            <h3>Server name:</h3>
            <p>The name of your server on ValheimList.org</p>
            <input id="name" data-max="30" class="input-box"><br>
            <div class="input-length-display">0/30 Characters used.</div>
        </div>

        <div class="item-block">
            <h3>Game server IP & port:</h3>
            <p>The port your gameserver is exposed on. If default you do not need to put the port.</p>
            <input id="ip" class="input-box" placeholder="255.255.255.255:2456">
        </div>

        <div class="item-block">
            <h3>Steam matchmaking IP & port:</h3>
            <p>Upon entry ValheimList.org will begin pinging your server every 5 minutes. If default you do not need to
                put the port. If you aren't sure what this is, try putting whatever port you used for your server PLUS 1. So if your gameserver runs on port 1000 try port 1001.</p>
            <p>If your server fails to respond to a Steamworks Challenge for more than 7 days we will automatically make your ValheimList.org listing private.</p>
            <input id="ip_mm" class="input-box" placeholder="255.255.255.255:2457">
        </div>

        <div class="item-block">
            <h3>Discord Guild ID:</h3>
            <p>Found by looking at the first string of numbers appearing in the URL while viewing your guild. <br>Allows
                ValheimList.org to directly add players to your Discord without displaying the intermediate join
                acceptance screen.</p>
            <input id="guild_id" class="input-box" placeholder="820120530107367435">
        </div>

        <div class="item-block">
            <h3>Discord invite link:</h3>
            <p>Don't forget to pick the channel you want new players to be in when you generate your invite link.</p>
            <input id="discord_link" class="input-box" placeholder="https://discord.gg/ameHJz5PFk">
        </div>

        <div class="item-block">
            <h3>Require player whitelist:</h3>
            <p>If your server has a whitelist or password check this box.</p>
            <label class="form-switch">
                <input id="is_whitelist" type="checkbox">
                <i></i>
            </label>
        </div>

        <div class="item-block">
            <h3>Short Summary:</h3>
            <p>Appears in the header of your listing and on the public list.</p>
            <textarea id="summary" data-max="80" class="input-box" placeholder="Empty"></textarea>
            <br><div class="input-length-display">0/80 Characters used.</div>
        </div>

        <div class="item-block">
            <h3>Categories:</h3>
            <p>Select the categories that describe your server.</p>
            <table cellspacing="0" rules="all" border="1" id="Table1" style="border-collapse: collapse;">
                <tr>
                    <th style="width:100px">Selected</th>
                    <th style="width:140px">Category</th>
                </tr>
                <tr>
                    <td><label class="form-switch">
                        <input id="PvP" type="checkbox">
                        <i></i>
                    </label></td>
                    <td>PvP</td>
                </tr>
                <tr>
                    <td><label class="form-switch">
                        <input id="PvE" type="checkbox">
                        <i></i>
                    </label></td>
                    <td>PvE</td>
                </tr>
                <tr>
                    <td><label class="form-switch">
                        <input id="Unmodded" type="checkbox">
                        <i></i>
                    </label></td>
                    <td>Un-modded</td>
                </tr>
                <tr>
                    <td><label class="form-switch">
                        <input id="Modded" type="checkbox">
                        <i></i>
                    </label></td>
                    <td>Modded</td>
                </tr>
                <tr>
                    <td><label class="form-switch">
                        <input id="Small" type="checkbox">
                        <i></i>
                    </label></td>
                    <td>Small (less than 10 slots)</td>
                </tr>
            </table>

        </div>

        <div class="item-block">
            <h3>Location:</h3>
            <p>Select where your server is so players know what latency to expect.</p>
            <select id="location">
                <option value="na">North America</option>
                <option value="sa">South America</option>
                <option value="eu">Europe</option>
                <option value="asia">Asia</option>
                <option value="oceania">Oceania</option>
            </select>

        </div>

        <div class="item-block">
            <h3>Welcome Text:</h3>
            <p>Must not exceed 300 characters.</p>
            <p>Appears below the page header but above your server content. Use it to provide users with an overview of
                the main points of your server.</p>
            <textarea id="welcome_text" data-max="300" class="input-box" placeholder="Empty"></textarea>
            <br><div class="input-length-display">0/300 Characters used.</div>
        </div>

        <div class="item-block">
            <h3>Youtube Video code:</h3>
            <p>Optionally show a video before your images. Paste only the code for the video, not the entire URL. For example if this is your video URL "https://www.youtube.com/watch?v=rMvZpFp-9VU" then your code is "rMvZpFp-9VU"</p>
            <input id="youtube_url" class="input-box" placeholder="rMvZpFp-9VU"></input>
        </div>

        <div class="item-block">
            <h3>Server Image & Page Images:</h3>
            <p>After uploading multiple images you can assign their ordering as well as select a icon for your server. You may have up to 12 images. Files must not exceed 500kb. <br><br><b>When you upload an image the page will refresh. Make sure all of your other changes are saved first.</b>
            <br><br>Image must be of type: .JPG, .PNG, .GIF, .WEBP.
            </p>
                <input type="file" id="filebox" name="filename"><br>
                <input type="submit" onclick="uploadImage()" value="Upload Image" >
            <br>
            <div style="display: none" id="image-warn"></div>
            <h3>Image ordering:</h3>
            <p>Edit the field number to change image order. PLEASE READ: The image in position one will be used as the logo. By default images uploaded go into position 12. Make sure you put your images into the positions that you want.<br>If any images have the same priority number they will be alternated at random on your page. It's suggested not to have multiple images in position one.</p>
            <div id="image-list"></div><br>
            <input type="submit" onclick="sendImageManagementData()" value="Submit">
        </div>

        <div class="item-block">
            <h3>Features Text:</h3>
            <p><b>Required.</b> Must not exceed 1000 characters.</p>
            <textarea id="features_text" data-max="1000" class="input-box" placeholder="Empty"></textarea>
            <br><div class="input-length-display">0/1000 Characters used.</div>
        </div>

        <div class="item-block">
            <h3>About Text:</h3>
            <p>Must not exceed 1000 characters.</p>
            <textarea id="about_text" data-max="1000" class="input-box" placeholder="Empty"></textarea>
            <br><div class="input-length-display">0/1000 Characters used.</div>
        </div>

        <div class="item-block">
            <h3>About Server Staff Text:</h3>
            <p>Must not exceed 1000 characters.</p>
            <textarea id="about_owner_text" data-max="1000" class="input-box" placeholder="Empty"></textarea>
            <br><div class="input-length-display">0/1000 Characters used.</div>
        </div>

        <div class="item-block">
            <h3>Server UUID:</h3>
            <div id="server-uuid"></div>
        </div>

        <div class="item-block">
            <h3>Created at:</h3>
            <p>Creation time formatted as rfc2822.</p>
            <div id="created_at">Loading...</div>
        </div>

        <div class="item-block">
            <h3>Owner Discord ID:</h3>
            <p>Contact support to transfer your server to a new owner.</p>
            <div id="owner">Loading...</div>
        </div>

        <div class="item-block">
            <h3>DANGER Delete Server:</h3>
            <p>If you wish to delete your server permanently flip the switch and save. If you are unsatisfied with ValheimList.org please let us know why in our Discord.</p>
            <label class="form-switch">
                <input id="is_deleted" type="checkbox">
                <i></i>
            </label>
        </div>

    </div>

</div>

<div class="unsaved-holder">
    <div id="unsaved">You have unsaved changes!</div>
</div>

</body>
</html>
<script src="assets/scripts/scripts.js"></script>
<script>

    e('server-uuid').innerHTML = `${getQueryVariable("s")}`;
    let dataObj

    function getServerData() {
        fetch(serverAddress + `/getserverdata?sid=${getQueryVariable("s")}`)
            .then(response => response.json())
            .then(data => {
                console.log(data)
                e("name-2").innerHTML = `Edit "${data["name"]}"`;
                e("created_at").innerHTML = data["created_at"];
                e("owner").innerHTML = data["owner"];
                dataObj = data;
                registerListeners()
            });
    }

    getServerData()

    let submitControls = `<div class="submit-controls">
<div class="submit-bg-hack"></div>
<button onclick="saveField(this)">Save</button>
<button onclick="revertField(this)">Revert</button>
</div>`


    function insertControls(inputs, controlType, accessType) {
        inputs.forEach(function (item) {
            let parent = e(item).parentElement;
            e(item)[accessType] = dataObj[item];
            renderCharCounter(controlType, parent)
            e(item).addEventListener(controlType, function () {
                if (renderCharCounter(controlType, parent)) return;
                if (e(item)[accessType] === dataObj[item]) {
                    removeControls(parent)
                } else {
                    if (parent.getElementsByClassName("submit-controls").length === 0) {
                        parent.insertAdjacentHTML("beforeend", submitControls);
                    }
                }
            })
        })
    }

    function renderCharCounter(controlType, parent) {
        if (controlType === "input") {
            let target = parent.getElementsByClassName("input-box")[0];

            if (target.dataset.max) {
                parent.getElementsByClassName("input-length-display")[0].innerHTML = `${target.value.length}/${target.dataset.max} Characters used.`
                if (target.value.length > target.dataset.max) {
                    parent.getElementsByClassName("input-length-display")[0].style.backgroundColor = "#823434";
                    removeControls(parent)
                    return true
                } else {
                    parent.getElementsByClassName("input-length-display")[0].style.backgroundColor = "#4e4e4e";

                }
            }
        }
    }

    function removeControls(parent) {
        if (parent.getElementsByClassName("submit-controls").length !== 0) {
            parent.removeChild(
                parent
                    .getElementsByClassName("submit-controls")[0])
        }
    }

    let categoriesState
    let categories = ["PvP", "PvE", "Modded", "Unmodded", "Small"]
    let catControls = `<div class="submit-controls">
<div class="submit-bg-hack"></div>
<button onclick="saveCategories()">Save</button>
<button onclick="revertCat()">Revert</button>
</div>`

    let catRegisteredAlready = false;
    function registerCategoriesInput() {
        categoriesState = dataObj["categories"].slice(0);
        let parent = e("PvP").parentElement.parentElement.parentElement.parentElement.parentElement.parentElement; //we need to anchor ourselves to the div so we just grab the first list item to locate where we are

        categories.forEach(function (item) {
            if (dataObj["categories"].includes(item)) {
                e(item).checked = true;
            } else {
                e(item).checked = false;
            }
            if (catRegisteredAlready) {
                removeControls(parent)
                return
            }
            e(item).addEventListener("change", function () {
                if (e(item).checked) {
                    categoriesState.push(item)
                } else {
                    if (categoriesState.indexOf(item) > -1) {
                        categoriesState.splice(categoriesState.indexOf(item), 1);
                    }
                }

                if (categoriesState === dataObj["categories"]) {
                    removeControls(parent)
                } else {
                    if (parent.getElementsByClassName("submit-controls").length === 0) {
                        parent.insertAdjacentHTML("beforeend", catControls);
                    }
                }

            })
        })
        catRegisteredAlready = true
    }

    function revertCat() {
        registerCategoriesInput()
    }

    function saveCategories(ele) {
        let parent = e("PvP").parentElement.parentElement.parentElement.parentElement.parentElement.parentElement; //we need to anchor ourselves to the div so we just grab the first list item to locate where we are

        let valueObj = {};
        valueObj["server"] = getQueryVariable("s");
        valueObj["field"] = "categories";
        valueObj["value"] = categoriesState;

        fetch(serverAddress + '/update_server_field', {
            method: 'POST',
            headers: {
                'session': localStorage.getItem('session'),
                'uid': localStorage.getItem('id')
            },
            body: JSON.stringify(valueObj)
        })
            .then(response => response.json())
            .then(data => {
                if ("ok" in data) {
                    dataObj["categories"] = categoriesState.slice(0)
                    removeControls(parent)
                }
            });
    }

    function registerListeners() {
        //text inputs
        let textInputs = ["name", "ip", "ip_mm", "guild_id", "discord_link", "summary", "welcome_text", "youtube_url",
            "features_text", "about_text", "about_owner_text"]
        insertControls(textInputs, "input", "value")

        let switchInputs = ["is_public", "is_whitelist", "is_deleted"]
        insertControls(switchInputs, "change", "checked")

        let selectInputs = ["location"]
        insertControls(selectInputs, "change", "value")

        //categories custom
        registerCategoriesInput()

        dataObj["images"].forEach(function (item) {
            let template = `<div data-id="${item.id}">${item.filename}<input oninput="updateImagePriority('${item.id}', this.value)" min="1" max="12" id="${item.id}" type="number"><span onclick="deleteImage('${item.id}')" class="delete-image">X</span></div>`
            e("image-list").insertAdjacentHTML("beforeend", template);
            e(item.id).value = item.position
        })

    }

    function strip(str) {
        return str.replace(/^\s+|\s+$/g, '');
    }

    function saveField(ele) {
        e("unsaved").style.top = "-60px"
        let parent = ele.parentElement.parentElement
        let controls = ele.parentElement
        let inputElm = parent.querySelectorAll('*[id]')[0]
        let field = inputElm.getAttribute('id')
        inputElm.disabled = true
        let inputVal

        if (inputElm.type === "text" || inputElm.type === "textarea") {
            inputVal = strip(inputElm.value)
            inputElm.value = inputVal;
        } else if (inputElm.type === "checkbox") {
            inputVal = inputElm.checked
        }else if (inputElm.type === "select-one") {
            inputVal = inputElm.value
        }

        let valueObj = {};
        valueObj["server"] = getQueryVariable("s");
        valueObj["field"] = field;
        valueObj["value"] = inputVal;

        //console.log(valueObj)

        fetch(serverAddress + '/update_server_field', {
            method: 'POST',
            headers: {
                'session': localStorage.getItem('session'),
                'uid': localStorage.getItem('id')
            },
            body: JSON.stringify(valueObj)
        })
            .then(response => response.json())
            .then(data => {
                inputElm.disabled = false
                if ("ok" in data) {
                    if(field === "is_deleted") {
                        window.location.href=staticsiteAddress+"/listownedservers.html"
                    }

                    dataObj[inputElm.getAttribute('id')] = inputVal
                    removeControls(parent)
                    inputElm.style.borderColor = "#00fd00";
                    setTimeout(function(){
                        inputElm.style.borderColor = "#3d3d3d";
                        }, 1000);
                }
            });
    }
    function revertField(ele) {
        // ele is "this"
        e("unsaved").style.top = "-60px"
        let parent = ele.parentElement.parentElement
        let inputElm = parent.querySelectorAll('*[id]')[0]
        let field = inputElm.getAttribute('id');
        if (inputElm.type === "text" || inputElm.type === "textarea") {
            inputElm.value = dataObj[field]
        } else if (inputElm.type === "checkbox") {
            inputElm.checked = dataObj[field]
        }else if (inputElm.type === "select-one") {
            inputElm.value = dataObj[field]
        }

        removeControls(parent)
    }

    function uploadImage() {
        e("image-warn").style.display = "none"
        let file = e("filebox").files[0]
        if (file === undefined) {
            e("image-warn").innerHTML = "You must select a file..."
            e("image-warn").style.display = "block"
            return
        }

        switch (file.type) {
            case "image/jpeg": {break}
            case "image/png": {break}
            case "image/gif": {break}
            case "image/webp": {break}
                default: {
                    e("image-warn").innerHTML = "The image you selected was of an unacceptable type."
                    e("image-warn").style.display = "inline-block"
                }
        }
        if(file.size > 500000) {
            e("image-warn").innerHTML = "The file you choose exceeds the limit of 500kb."
            e("image-warn").style.display = "inline-block"
            return
        }
        let reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(e) {

            const imageUploadPackage = {
                filetype: file.type,
                filename: file.name,
                blob: e.target.result,
                server: getQueryVariable("s")
            }

            fetch(serverAddress + '/manage_images', {
                method: "POST",
                body: JSON.stringify(imageUploadPackage),
                headers: {
                    'session': localStorage.getItem('session'),
                    'uid': localStorage.getItem('id')
                },
            }).then(response => {
                window.location.reload();
            });
        };

        reader.onerror = function() {
            console.log(reader.error);
        };
    }

    let imageManagementObj = {
        toDelete: [],
        toOrder: {},
        server: getQueryVariable("s")
    }

    function setVisitPageUrl() {
        let uuid = getQueryVariable("s")
        e("page-url").innerHTML = `<h3>Visit your page:</h3> <a href="https://valheimlist.org/listing/${uuid}">https://valheimlist.org/listing/${uuid}</a>`
    }
    setVisitPageUrl()

    function deleteImage(id) {
        e(id).parentElement.remove();
        imageManagementObj.toDelete.push(id)
    }

    function updateImagePriority(id, priority) {
        imageManagementObj.toOrder[id] = parseInt(priority)
    }

    function sendImageManagementData() {
        fetch(serverAddress + '/alter_images', {
            method: "POST",
            body: JSON.stringify(imageManagementObj),
            headers: {
                'session': localStorage.getItem('session'),
                'uid': localStorage.getItem('id')
            },
        }).then((response) => response.json().then(res => ({status: response.status, data: res})))
            .then((apiResponse) => {
                console.log(apiResponse.status)
                if (apiResponse.status === 200) {
                    window.location.reload();
                }
                else {console.log(apiResponse)}
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }




    window.addEventListener('load', (event) => {
        let preload = document.getElementsByClassName("preload");
        while (preload.length)
            preload[0].className = preload[0].className.replace(/\bpreload\b/g, "");
    });

    /*
    const interval = setInterval(function() {
        if(document.getElementsByClassName("submit-controls").length !== 0) {
            e("unsaved").style.top = "20px"
        }
    }, 5000);

     */

</script>

<style>
    #image-list {
        width: 440px;
        background: #1c1911;
        padding: 10px;
        border: 1px solid #fff9d9;
    }
    #image-list div {
        margin: 15px auto;
        width: 400px;
        background-color: rgba(255, 255, 255, 0.74);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #000;
        position: relative;
        display: block;
    }
    #image-list input {
        width: 40px;
        height: 18px;
        margin: 0;
        position: absolute;
        right: 50px;
    }
    .delete-image {
        position: absolute;
        cursor: pointer;
        right:0;
        top:0;
        height: 40px;
        padding: 10px 0;
        width: 40px;
        background-color: red;
        color: white;
        text-align: center;
        font-weight: bold;
    }
    #image-warn {
        background-color: #823434;
    }
    #unsaved {
        background-color: orange;
        color: #000;
        font-size: 20px;
        padding: 8px 0;
        border-radius: 5px;
        width: 400px;
        text-align: center;
        position: fixed;
        top: -60px;
        left: calc(50% - 200px);
        display: inline-block;
        transition: 400ms;
        transition-timing-function: ease-in-out;
    }
    .preload * {
        -webkit-transition: none !important;
        -moz-transition: none !important;
        -ms-transition: none !important;
        -o-transition: none !important;
    }
    .edit-server {
        background-color: #282828;
        padding: 30px;
    }

    table {
        color: #a0a0a0;
        background-color: #313131;
    }

    tr {
        text-align: center;
    }

    td label {
        margin-top: 8px
    }

    h1 {
        position: static;
        padding-bottom: 10px;
        border-bottom: 2px solid #494949;
    }
    .submit-bg-hack {
        position: absolute;
        top:0;
        left:0;
        width: 191px;
        height: 100%;
        background-color: #4c442e !important;
        border: 1px solid #ffbf00;
        border-radius: 5px;
        z-index: 1;
        margin: 0!important;
    }
    .submit-controls {
        position: relative;

        display: block!important;
        background:none!important;
        padding:5px!important;
    }
    .submit-controls button {
        position: relative;
        z-index: 10;
        padding: 10px 25px;
        font-weight: bold;
        cursor: pointer;
    }
    .submit-controls button:last-child {
        background: none;
        color: #fff;
        border:none;
    }
    .submit-controls button:last-child:hover {
        color: red!important;
    }

    .item-block {
        padding-bottom: 20px;
        border-bottom: 1px solid #323232;
    }

    .item-block div {
        padding: 10px 20px;
        margin: 10px 0;
        color: #cdcdcd;
        background-color: #4e4e4e;
        display: inline-block;
    }


    h3 {
        margin: 30px 0 0 0;
    }

    p {
        color: #d5d5d5;
        font-size: 14px;
        line-height: 20px;
        max-width: 700px;
        padding: 10px 0 20px 0;
    }

    i, input {
        margin-bottom: 10px;
    }

    .input-check {
        width: 40px;
        height: 40px;
    }

    .input-box {
        border: 1px solid #3d3d3d;
        width: 600px;
        min-height: 45px;
        border-radius: 5px;
        color: #cffff2;
        padding: 20px;
        font-size: 16px;
        background-color: #000;
        background-repeat: no-repeat;
        background-size: 25px;
        background-position: 16px 9px;
        font-family: "import", sans-serif;
        transition: 500ms;
    }

    textarea {
        padding: 10px 0;
        min-height: 220px!important;
    }

    .form-switch {
        display: inline-block;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
    }

    .form-switch i {
        position: relative;
        display: inline-block;
        margin-right: .5rem;
        width: 46px;
        height: 26px;
        background-color: #d7d7d7;
        border-radius: 23px;
        vertical-align: text-bottom;
        transition: all 0.3s linear;
    }

    .form-switch i::before {
        content: "";
        position: absolute;
        left: 0;
        width: 42px;
        height: 22px;
        background-color: #eaeaea;
        border-radius: 11px;
        transform: translate3d(2px, 2px, 0) scale3d(1, 1, 1);
        transition: all 0.25s linear;
    }

    .form-switch i::after {
        content: "";
        position: absolute;
        left: 0;
        width: 22px;
        height: 22px;
        background-color: #fff;
        border-radius: 11px;
        box-shadow: 0 2px 2px rgba(0, 0, 0, 0.24);
        transform: translate3d(2px, 2px, 0);
        transition: all 0.2s ease-in-out;
    }

    .form-switch:active i::after {
        width: 28px;
        transform: translate3d(2px, 2px, 0);
    }

    .form-switch:active input:checked + i::after {
        transform: translate3d(16px, 2px, 0);
    }

    .form-switch input {
        display: none;
    }

    .form-switch input:checked + i {
        background-color: #00f6fd;
    }

    .form-switch input:checked + i::before {
        transform: translate3d(18px, 2px, 0) scale3d(0, 0, 0);
    }

    .form-switch input:checked + i::after {
        transform: translate3d(22px, 2px, 0);
    }

    .item-block a {
        display: inline-block;
        margin: 20px 0!important;
        color: #fff;
    }
</style>
